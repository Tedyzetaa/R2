import cv2
import time
import os

class SentinelSystem:
    def __init__(self):
        self.camera_index = 0

    def capturar_intruso(self):
        print("ğŸ‘ï¸ [DEBUG]: Iniciando mÃ³dulo Sentinela...")
        cap = None
        
        # Define caminho ABSOLUTO para salvar (evita erro de pasta)
        nome_arquivo = "sentinel_capture.png"
        caminho_completo = os.path.abspath(nome_arquivo)
        
        try:
            # Tenta forÃ§ar o driver DSHOW (que funcionou no seu teste)
            print(f"ğŸ‘ï¸ [DEBUG]: Abrindo cÃ¢mera {self.camera_index} (DSHOW)...")
            cap = cv2.VideoCapture(self.camera_index, cv2.CAP_DSHOW)
            
            # Se falhar, tenta sem driver especÃ­fico
            if not cap.isOpened():
                print("âš ï¸ [DEBUG]: Falha no DSHOW. Tentando driver padrÃ£o...")
                cap = cv2.VideoCapture(self.camera_index)

            if not cap.isOpened():
                return None, "âŒ Erro CrÃ­tico: O Windows nÃ£o liberou o acesso Ã  cÃ¢mera."

            # Configura resoluÃ§Ã£o (ajuda a estabilizar)
            cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
            cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)

            print("ğŸ‘ï¸ [DEBUG]: Aquecendo sensor (Aguarde)...")
            # LÃª 10 frames para limpar o buffer preto inicial
            for i in range(10):
                cap.read()
                time.sleep(0.1) # Pausa leve para o hardware respirar

            print("ğŸ‘ï¸ [DEBUG]: Capturando frame final...")
            ret, frame = cap.read()
            
            if ret and frame is not None:
                # Salva no caminho absoluto
                cv2.imwrite(caminho_completo, frame)
                print(f"âœ… [DEBUG]: Foto salva em: {caminho_completo}")
                return caminho_completo, "ğŸ“¸ Sentinela: Imagem capturada com sucesso."
            else:
                return None, "âŒ Erro: A cÃ¢mera abriu, mas a imagem veio vazia (tela preta)."

        except Exception as e:
            print(f"âŒ [ERRO]: {e}")
            return None, f"âŒ Falha de Script: {e}"
            
        finally:
            if cap: 
                cap.release()
                print("ğŸ‘ï¸ [DEBUG]: CÃ¢mera liberada.")