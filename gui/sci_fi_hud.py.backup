"""
Main Sci-Fi/HUD interface for R2 Assistant
"""

import customtkinter as ctk
import threading
import time
import random
import json
from datetime import datetime
from typing import Dict, List, Optional, Callable, Any
from pathlib import Path

from core.config import AppConfig
from core.history_manager import HistoryManager, EventType
from core.analytics import Analytics
from core.voice_engine import VoiceEngine
from core.audio_processor import AudioProcessor
from core.language_model import LanguageModel
from core.command_system import CommandSystem
from core.alert_system import AlertSystem, AlertLevel
from core.function_handler import FunctionHandler
from core.module_manager import ModuleManager, ModuleStatus

from .theme import SciFiTheme
from .components.wave_animation import WaveAnimation
from .components.circular_gauge import CircularGauge
from .components.datastream import DataStreamVisualization
from .components.alert_panel import AlertPanel
from .components.module_panel import ModulePanel
from .components.network_map import NetworkMap

class R2SciFiGUI(ctk.CTk):
    """Main Sci-Fi/HUD interface window"""
    
    def __init__(self, config=None):
        """Initialize the Sci-Fi HUD interface"""
        print("üöÄ Initializing R2 Sci-Fi HUD...")
        
        # Se config n√£o for fornecido, criar uma
        if config is None:
            from core.config import AppConfig
            self.config = AppConfig()
            print("‚ö†Ô∏è  No config provided, using default AppConfig")
        else:
            self.config = config
        
        # Verificar se config tem todos os atributos necess√°rios
        self._validate_config()
        
        super().__init__() # Chamar o inicializador da classe pai
        self.theme = SciFiTheme()
        
        # Initialize core components
        self._init_core_components()
        
        # Initialize voice state variable - NOVA LINHA
        self.voice_active = False
        
        # Build interface
        self._build_interface()
        
        # Start system
        self._start_system()
        
    def _validate_config(self):
        """Valida se a configura√ß√£o tem todos os atributos necess√°rios"""
        required_attrs = [
            'DATA_DIR', 'UI_THEME', 'MAX_HISTORY_SIZE',
            'WINDOW_WIDTH', 'WINDOW_HEIGHT'
        ]
        
        for attr in required_attrs:
            if not hasattr(self.config, attr):
                print(f"‚ö†Ô∏è  Config missing attribute: {attr}")
                # Definir valores padr√£o
                if attr == 'UI_THEME':
                    setattr(self.config, attr, 'sci-fi')
                elif attr == 'MAX_HISTORY_SIZE':
                    setattr(self.config, attr, 1000)
                elif attr == 'WINDOW_WIDTH':
                    setattr(self.config, attr, 1600)
                elif attr == 'WINDOW_HEIGHT':
                    setattr(self.config, attr, 900)

    def _init_core_components(self):
        print("üîß Initializing core components...")
        
        # History and analytics - CORRIGIDO COM VERIFICA√á√ÉO DEFENSIVA
        max_size = getattr(self.config, 'MAX_HISTORY_SIZE', 1000)
        persist_file = None
        
        if hasattr(self.config, 'DATA_DIR'):
            data_dir = self.config.DATA_DIR
            
            # DEFESA: Garantir que data_dir seja um Path object
            # Se for string, converter para Path
            if isinstance(data_dir, str):
                from pathlib import Path
                # Verificar se √© caminho absoluto
                import os
                if os.path.isabs(data_dir):
                    data_dir = Path(data_dir)
                else:
                    # Se for relativo, assumir relativo ao PROJECT_ROOT
                    if hasattr(self.config, 'PROJECT_ROOT'):
                        data_dir = self.config.PROJECT_ROOT / data_dir
                    else:
                        data_dir = Path(__file__).parent.parent / data_dir
            
            # Agora data_dir definitivamente √© um Path
            persist_file = data_dir / 'history.json'
            
            # Log para debug
            print(f"üìÅ History file: {persist_file}")
            print(f"üìÅ Data dir type: {type(data_dir)}, value: {data_dir}")
        
        self.history = HistoryManager(max_size=max_size, persist_file=persist_file)
        
        # Analytics com fallback
        try:
            self.analytics = Analytics()
        except:
            print("‚ö†Ô∏è Analytics falhou, usando dummy")
            self.analytics = None
        
        # Voice and audio com fallback
        try:
            self.voice_engine = VoiceEngine(self.config)
        except Exception as e:
            print(f"‚ö†Ô∏è VoiceEngine falhou: {e}")
            self.voice_engine = None
        
        try:
            self.audio_processor = AudioProcessor(self.config)
        except:
            print("‚ö†Ô∏è AudioProcessor falhou")
            self.audio_processor = None
        
        # AI and command system com fallback
        try:
            self.language_model = LanguageModel(self.config)
        except:
            print("‚ö†Ô∏è LanguageModel falhou")
            self.language_model = None
        
        try:
            self.command_system = CommandSystem()
        except:
            print("‚ö†Ô∏è CommandSystem falhou")
            self.command_system = None
        
        try:
            self.function_handler = FunctionHandler(self.config)
        except:
            print("‚ö†Ô∏è FunctionHandler falhou")
            self.function_handler = None
        
        # Alert system - INICIALIZA√á√ÉO SEGURA
        # N√£o passar callback ainda, ser√° configurado ap√≥s UI
        try:
            self.alert_system = AlertSystem(self.config, notification_callback=None)
            # N√£o iniciar monitoramento ainda
            self.alert_system.is_monitoring = False
        except Exception as e:
            print(f"‚ö†Ô∏è AlertSystem falhou: {e}")
            self.alert_system = None
        
        # Module manager com fallback
        try:
            self.module_manager = ModuleManager(self.config)
        except Exception as e:
            print(f"‚ö†Ô∏è ModuleManager falhou: {e}")
            self.module_manager = None
        
        # Inicializar m√©tricas
        self.metrics = {
            'cpu_usage': 0.0,
            'memory_usage': 0.0,
            'network_speed': 0.0,
            'response_time': 0.0
        }
        
        print("‚úÖ Core components initialized with fallbacks")
        
    def _setup_window(self):
        """Setup main window properties"""
        self.title("R2 ASSISTANT - SCI-FI/HUD INTERFACE")
        self.geometry(f"{self.config.WINDOW_WIDTH}x{self.config.WINDOW_HEIGHT}")
        
        # Configure theme
        ctk.set_appearance_mode("dark")
        ctk.set_default_color_theme("dark-blue")
        
        # Make window fullscreen optional
        self.attributes('-fullscreen', False)
        
        # Configure grid
        self.grid_rowconfigure(0, weight=1)        
        self.grid_columnconfigure(0, weight=1)
        
    def _build_interface(self):
        """Setup window and build UI elements - VERS√ÉO SEGURA"""
        print("üé® Building Sci-Fi/HUD interface (vers√£o segura)...")
        
        try:
            self._setup_window()
            self._build_ui()
            print("‚úÖ Interface constru√≠da com sucesso!")
            
        except Exception as e:
            print(f"‚ùå Erro na constru√ß√£o da interface: {e}")
            print("üîÑ Usando interface simplificada...")
            self._create_simple_interface()
    
    def _create_simple_interface(self):
        """Cria uma interface simplificada quando a completa falha"""
        import customtkinter as ctk
        
        print("üîß Criando interface simplificada...")
        
        # Limpar qualquer widget existente
        for widget in self.winfo_children():
            try:
                widget.destroy()
            except:
                pass
        
        # Usar apenas pack para evitar conflitos
        self.grid_forget()
        
        # Frame principal
        self.main_frame = ctk.CTkFrame(self)
        self.main_frame.pack(fill="both", expand=True, padx=20, pady=20)
        
        # T√≠tulo
        title_frame = ctk.CTkFrame(self.main_frame)
        title_frame.pack(fill="x", pady=(0, 20))
        
        ctk.CTkLabel(
            title_frame,
            text="ü§ñ R2 ASSISTANT - INTERFACE SIMPLIFICADA",
            font=("Arial", 24, "bold"),
            text_color="#00ffff"
        ).pack(pady=10)
        
        # Status
        ctk.CTkLabel(
            title_frame,
            text="‚úÖ Sistema operacional - Alguns m√≥dulos podem estar indispon√≠veis",
            font=("Arial", 12),
            text_color="#88ff88"
        ).pack()
        
        # Console de sa√≠da
        self.console = ctk.CTkTextbox(
            self.main_frame,
            height=400,
            font=("Consolas", 12),
            wrap="word"
        )
        self.console.pack(fill="both", expand=True, pady=(0, 15))
        self.console.insert("1.0", "R2 Assistant inicializado em modo simplificado\n\n")
        
        # Mensagens iniciais
        self.console.insert("end", "üöÄ Sistema inicializado com sucesso\n")
        self.console.insert("end", "‚úÖ Comandos b√°sicos dispon√≠veis\n")
        self.console.insert("end", "üí¨ Digite 'ajuda' para ver comandos\n\n")
        
        # Frame de entrada
        input_frame = ctk.CTkFrame(self.main_frame)
        input_frame.pack(fill="x")
        
        self.input_field = ctk.CTkEntry(
            input_frame,
            placeholder_text="Digite um comando...",
            font=("Arial", 14),
            height=40
        )
        self.input_field.pack(side="left", fill="x", expand=True, padx=(0, 10))
        self.input_field.bind("<Return>", lambda e: self._process_simple_command())
        
        self.send_btn = ctk.CTkButton(
            input_frame,
            text="Enviar",
            width=100,
            height=40,
            font=("Arial", 14),
            command=self._process_simple_command
        )
        self.send_btn.pack(side="right")
        
        # Bot√µes de a√ß√£o
        buttons_frame = ctk.CTkFrame(self.main_frame)
        buttons_frame.pack(fill="x", pady=(10, 0))
        
        actions = [
            ("üîÑ Reiniciar", self._restart_gui),
            ("‚öôÔ∏è Configura√ß√£o", lambda: print("Configura√ß√£o")),
            ("üìä Status", self._show_status),
            ("‚ùå Sair", self.quit)
        ]
        
        for text, command in actions:
            btn = ctk.CTkButton(
                buttons_frame,
                text=text,
                command=command,
                height=35
            )
            btn.pack(side="left", padx=5)
    
    def _build_ui(self):
        """Build the complete UI"""
        print("üé® Building Sci-Fi/HUD interface...")
        
        # Main container
        self.main_container = ctk.CTkFrame(self, fg_color=self.theme.colors['bg_dark'])
        self.main_container.grid(row=0, column=0, sticky="nsew", padx=2, pady=2)
        self.main_container.grid_rowconfigure(0, weight=1)
        self.main_container.grid_columnconfigure(0, weight=1)
        
        # Create main grid (3x3)
        self._create_main_grid()
        
        # Top bar
        self._create_top_bar()
        
        # Left panel
        self._create_left_panel()
        
        # Center panel
        self._create_center_panel()
        
        # Right panel
        self._create_right_panel()
        
        # Bottom bar
        self._create_bottom_bar()

    def _setup_alert_system(self):
        """Configura o sistema de alertas ap√≥s a UI estar pronta"""
        if self.alert_system and hasattr(self, 'alert_panel'):
            # Agora sim, configurar o callback
            self.alert_system.notification_callback = self._on_alert_received
            # Iniciar monitoramento
            self.alert_system.start_monitoring()
            print("‚úÖ Alert system configured and started")

    def _on_alert_received(self, alert_data: Dict[str, Any]):
        """Callback seguro para alertas"""
        self.after(0, self._on_alert_received_thread_safe, alert_data)
        
    def _create_main_grid(self):
        """Create the main 3x3 grid layout"""
        # Configure grid weights
        for i in range(3):
            self.main_container.grid_rowconfigure(i, weight=1)
            self.main_container.grid_columnconfigure(i, weight=1)
        
    def _create_top_bar(self):
        """Create top status bar"""
        top_frame = ctk.CTkFrame(
            self.main_container,
            height=60,
            fg_color=self.theme.colors['bg_medium'],
            corner_radius=0
        )
        top_frame.grid(row=0, column=0, columnspan=3, sticky="ew", padx=0, pady=0)
        top_frame.grid_propagate(False)
        
        # Left section - Title
        title_frame = ctk.CTkFrame(top_frame, fg_color="transparent")
        title_frame.pack(side="left", padx=20, pady=10)
        
        self.title_label = ctk.CTkLabel(
            title_frame,
            text="‚ö° R2 ASSISTANT - SCI-FI/HUD INTERFACE",
            font=self.theme.fonts['title'],
            text_color=self.theme.colors['primary']
        )
        self.title_label.pack()
        
        # Center section - System status
        status_frame = ctk.CTkFrame(top_frame, fg_color="transparent")
        status_frame.pack(side="left", padx=20, pady=10, expand=True)
        
        self.system_status_label = ctk.CTkLabel(
            status_frame,
            text="üü¢ SYSTEM STATUS: OPERATIONAL",
            font=self.theme.fonts['status'],
            text_color=self.theme.colors['success']
        )
        self.system_status_label.pack()
        
        # Right section - Connection status
        conn_frame = ctk.CTkFrame(top_frame, fg_color="transparent")
        conn_frame.pack(side="right", padx=20, pady=10)
        
        self.connection_label = ctk.CTkLabel(
            conn_frame,
            text="üåê CONNECTION: ESTABLISHED",
            font=self.theme.fonts['status_small'],
            text_color=self.theme.colors['info']
        )
        self.connection_label.pack()
        
    def _create_left_panel(self):
        """Create left panel (Communication Log & Analysis)"""
        left_frame = ctk.CTkFrame(
            self.main_container,
            fg_color=self.theme.colors['bg_panel'],
            corner_radius=8
        )
        left_frame.grid(row=1, column=0, sticky="nsew", padx=(10, 5), pady=5)
        
        # Communication Log
        comm_frame = self._create_panel(
            left_frame,
            "COMMUNICATION LOG",
            height=250
        )
        comm_frame.pack(fill="both", expand=True, pady=(0, 10))
        
        self.comm_log = ctk.CTkTextbox(
            comm_frame,
            font=self.theme.fonts['monospace'],
            text_color=self.theme.colors['text_bright'],
            fg_color=self.theme.colors['bg_dark'],
            border_width=0
        )
        self.comm_log.pack(fill="both", expand=True, padx=8, pady=8)
        
        # Analysis Charts
        analysis_frame = self._create_panel(
            left_frame,
            "ANALYSIS CHARTS",
            height=200
        )
        analysis_frame.pack(fill="both", expand=True)
        
        self._create_analysis_charts(analysis_frame)
        
    def _create_center_panel(self):
        """Create center panel (AI Core & Chat)"""
        center_frame = ctk.CTkFrame(
            self.main_container,
            fg_color=self.theme.colors['bg_panel'],
            corner_radius=8
        )
        center_frame.grid(row=1, column=1, sticky="nsew", padx=5, pady=5)
        
        # AI Core Animation
        core_frame = self._create_panel(
            center_frame,
            "AI CORE - REAL-TIME ACTIVITY",
            height=200
        )
        core_frame.pack(fill="x", pady=(0, 10))
        
        # Wave animation
        self.wave_animation = WaveAnimation(core_frame, size=180)
        self.wave_animation.pack(pady=10)
        
        # Chat interface
        chat_frame = self._create_panel(
            center_frame,
            "CHAT INTERFACE",
            height=300
        )
        chat_frame.pack(fill="both", expand=True)
        
        self._create_chat_interface(chat_frame)
        
    def _create_right_panel(self):
        """Create right panel (Performance Metrics & Datastream)"""
        right_frame = ctk.CTkFrame(
            self.main_container,
            fg_color=self.theme.colors['bg_panel'],
            corner_radius=8
        )
        right_frame.grid(row=1, column=2, sticky="nsew", padx=(5, 10), pady=5)
        
        # Performance Metrics
        metrics_frame = self._create_panel(
            right_frame,
            "PERFORMANCE METRICS",
            height=300
        )
        metrics_frame.pack(fill="both", expand=True, pady=(0, 10))
        
        self._create_performance_gauges(metrics_frame)
        
        # Datastream
        stream_frame = self._create_panel(
            right_frame,
            "REAL-TIME DATASTREAM",
            height=250
        )
        stream_frame.pack(fill="both", expand=True)
        
        self.data_stream = DataStreamVisualization(stream_frame, width=280, height=200)
        self.data_stream.pack(pady=10)
        
    def _create_bottom_bar(self):
        """Create bottom control bar"""
        bottom_frame = ctk.CTkFrame(
            self.main_container,
            height=80,
            fg_color=self.theme.colors['bg_medium'],
            corner_radius=0
        )
        bottom_frame.grid(row=2, column=0, columnspan=3, sticky="ew", padx=0, pady=0)
        bottom_frame.grid_propagate(False)
        
        # Left section - Control buttons
        controls_frame = ctk.CTkFrame(bottom_frame, fg_color="transparent")
        controls_frame.pack(side="left", padx=20, pady=10)
        
        self._create_control_buttons(controls_frame)
        
        # Center section - Alert panel
        alert_frame = ctk.CTkFrame(bottom_frame, fg_color="transparent")
        alert_frame.pack(side="left", padx=20, pady=10, expand=True)
        
        self.alert_panel = AlertPanel(alert_frame, max_alerts=3)
        self.alert_panel.pack(fill="both", expand=True)
        
        # Right section - System info
        info_frame = ctk.CTkFrame(bottom_frame, fg_color="transparent")
        info_frame.pack(side="right", padx=20, pady=10)
        
        self._create_system_info(info_frame)
        
    def _create_panel(self, parent, title: str, **kwargs) -> ctk.CTkFrame:
        """Create a styled panel with title"""
        panel = ctk.CTkFrame(
            parent,
            fg_color=self.theme.colors['bg_dark'],
            corner_radius=6,
            border_width=1,
            border_color=self.theme.colors['primary'],
            **kwargs
        )
        
        if title:
            title_label = ctk.CTkLabel(
                panel,
                text=title,
                font=self.theme.fonts['panel_title'],
                text_color=self.theme.colors['primary']
            )
            title_label.pack(pady=(8, 4), padx=8, anchor="w")
        
        return panel
    
    def _create_analysis_charts(self, parent):
        """Create analysis charts"""
        # Simple bar charts simulation
        charts_data = [
            ("INPUT ANALYSIS", 78, self.theme.colors['primary']),
            ("OUTPUT ANALYSIS", 65, self.theme.colors['secondary']),
            ("EFFICIENCY", 92, self.theme.colors['success']),
            ("ACCURACY", 88, self.theme.colors['accent'])
        ]
        
        for title, value, color in charts_data:
            chart_frame = ctk.CTkFrame(parent, fg_color="transparent", height=25)
            chart_frame.pack(fill="x", padx=10, pady=2)
            
            # Title
            ctk.CTkLabel(
                chart_frame,
                text=f"{title}:",
                font=self.theme.fonts['small'],
                text_color=self.theme.colors['text_dim'],
                width=120
            ).pack(side="left")
            
            # Progress bar
            progress = ctk.CTkProgressBar(
                chart_frame,
                fg_color=self.theme.colors['bg_medium'],
                progress_color=color,
                height=8
            )
            progress.pack(side="left", padx=(10, 5), fill="x", expand=True)
            progress.set(value / 100)
            
            # Value label
            ctk.CTkLabel(
                chart_frame,
                text=f"{value}%",
                font=self.theme.fonts['small_bold'],
                text_color=color,
                width=40
            ).pack(side="right")
            
    def _create_chat_interface(self, parent):
        """Cria a interface de chat usando o novo ChatPanel."""
        from .components.chat_panel import ChatPanel
        
        self.chat_panel = ChatPanel(
            parent,
            theme=self.theme,
            send_callback=self._on_send_message,
            voice_callback=self._toggle_voice
        )
        self.chat_panel.pack(fill="both", expand=True, padx=5, pady=5)
        
        print("‚úÖ Chat interface created using ChatPanel.")
        
    def _create_performance_gauges(self, parent):
        """Create performance gauges"""
        gauges_frame = ctk.CTkFrame(parent, fg_color="transparent")
        gauges_frame.pack(fill="both", expand=True, padx=10, pady=10)
        
        # Configure grid for gauges (2x2)
        for i in range(2):
            gauges_frame.grid_rowconfigure(i, weight=1)
            gauges_frame.grid_columnconfigure(i, weight=1)
        
        # Create gauges
        self.throughput_gauge = CircularGauge(
            gauges_frame,
            title="PROCESSING",
            value=self.metrics['cpu_usage'],
            max_value=100,
            unit="%",
            size=100,
            theme=self.theme
        )
        self.throughput_gauge.grid(row=0, column=0, padx=5, pady=5)
        
        self.queries_gauge = CircularGauge(
            gauges_frame,
            title="QUERIES",
            value=self.metrics['memory_usage'],
            max_value=100,
            unit="%",
            size=100,
            theme=self.theme
        )
        self.queries_gauge.grid(row=0, column=1, padx=5, pady=5)
        
        self.response_gauge = CircularGauge(
            gauges_frame,
            title="RESPONSE",
            value=99.5,
            max_value=100,
            unit="%",
            size=100,
            theme=self.theme
        )
        self.response_gauge.grid(row=1, column=0, padx=5, pady=5)
        
        self.network_gauge = CircularGauge(
            gauges_frame,
            title="NETWORK",
            value=self.metrics['network_speed'],
            max_value=100,
            unit="%",
            size=100,
            theme=self.theme
        )
        self.network_gauge.grid(row=1, column=1, padx=5, pady=5)
        
    def _create_control_buttons(self, parent):
        """Create control buttons"""
        buttons = [
            ("üé§ VOICE", self._toggle_voice, self.theme.colors['primary']),
            ("‚öôÔ∏è MODULES", self._open_modules, self.theme.colors['secondary']),
            ("üìä ANALYTICS", self._open_analytics, self.theme.colors['accent']),
            ("‚ö° TRADING", self._open_trading, self.theme.colors['warning']),
            ("üîß SETTINGS", self._open_settings, self.theme.colors['info']),
        ]
        
        for text, command, color in buttons:
            btn = ctk.CTkButton(
                parent,
                text=text,
                width=100,
                height=40,
                font=self.theme.fonts['button'],
                fg_color=color,
                hover_color=self.theme.colors['highlight'],
                command=command
            )
            btn.pack(side="left", padx=5)
            
            if text == "üé§ VOICE":
                self.voice_control_button = btn
    
    def _create_system_info(self, parent):
        """Create system information display"""
        info_frame = ctk.CTkFrame(parent, fg_color="transparent")
        info_frame.pack()
        
        # Time display
        self.time_label = ctk.CTkLabel(
            info_frame,
            text="",
            font=self.theme.fonts['monospace_small'],
            text_color=self.theme.colors['text_dim']
        )
        self.time_label.pack()
        
        # System load
        self.load_label = ctk.CTkLabel(
            info_frame,
            text="LOAD: 15%",
            font=self.theme.fonts['monospace_small'],
            text_color=self.theme.colors['text_dim']
        )
        self.load_label.pack()
        
    def _start_system(self):
        """Start system components and updates"""
        print("üöÄ Starting R2 Assistant system...")
        
        # Add startup messages
        self._add_comm_log("‚ö° SYSTEM INITIALIZATION STARTED")
        self._add_comm_log("‚úÖ AI Core: Online")
        self._add_comm_log("‚úÖ Voice Engine: Ready")
        self._add_comm_log("‚úÖ Alert System: Active")
        self._add_comm_log("üåå R2 ASSISTANT: OPERATIONAL")
        
        # Welcome message
        self._add_chat_message("R2", "üîä *System initialization complete*")
        self._add_chat_message("R2", "üåå Welcome to R2 Assistant - Sci-Fi/HUD Interface")
        self._add_chat_message("R2", "üéØ All systems operational and ready")
        self._add_chat_message("R2", "üí¨ Type your message or use voice commands...")
        
        # Configurar e iniciar sistema de alertas
        self._setup_alert_system()
        
        # Start updates - LINHA ORIGINAL PROBLEM√ÅTICA
        self._start_updates()  # Agora este m√©todo existir√°!

    def _start_updates(self):
        """Start periodic UI updates"""
        print("üîÑ Starting periodic UI updates...")
        
        # Iniciar todas as atualiza√ß√µes peri√≥dicas
        self._update_time()        # Atualiza rel√≥gio
        self._update_metrics()     # Atualiza m√©tricas do sistema
        self._update_datastream()  # Atualiza datastream
        self._update_system_status()  # Atualiza status do sistema
        
        # Iniciar anima√ß√£o wave se dispon√≠vel
        if hasattr(self, 'wave_animation') and self.wave_animation:
            try:
                self.wave_animation.start_animation()
            except Exception as e:
                print(f"‚ö†Ô∏è  N√£o foi poss√≠vel iniciar anima√ß√£o: {e}")
        
        # Iniciar atualiza√ß√µes do painel de alertas
        if hasattr(self, 'alert_panel') and self.alert_panel:
            try:
                # Verificar se o alert_panel tem m√©todo de atualiza√ß√£o
                if hasattr(self.alert_panel, 'start_updates'):
                    self.alert_panel.start_updates()
            except Exception as e:
                print(f"‚ö†Ô∏è  N√£o foi poss√≠vel iniciar atualiza√ß√µes de alertas: {e}")
        
        # Iniciar sistema de comandos se dispon√≠vel
        if hasattr(self, 'command_system') and self.command_system:
            try:
                self.command_system.start()
            except Exception as e:
                print(f"‚ö†Ô∏è  N√£o foi poss√≠vel iniciar sistema de comandos: {e}")
        
        print("‚úÖ UI updates started successfully")
        
    def _update_time(self):
        """Update time display"""
        current_time = datetime.now().strftime("%H:%M:%S")
        self.time_label.configure(text=f"TIME: {current_time}")
        self.after(1000, self._update_time)
        
    def _update_metrics(self):
        """Update performance metrics"""
        try:
            # Simulate metric updates
            self.metrics['cpu_usage'] = random.uniform(10, 80)
            self.metrics['memory_usage'] = random.uniform(30, 90)
            self.metrics['network_speed'] = random.uniform(70, 100)
            self.metrics['response_time'] = random.uniform(0.1, 0.5)
            
            # Update gauges
            self.throughput_gauge.set_value(self.metrics['cpu_usage'])
            self.queries_gauge.set_value(self.metrics['memory_usage'])
            self.response_gauge.set_value(100 - (self.metrics['response_time'] * 100))
            self.network_gauge.set_value(self.metrics['network_speed'])
            
            # Update load label
            self.load_label.configure(
                text=f"LOAD: {int(self.metrics['cpu_usage'])}%"
            )
            
        except Exception as e:
            print(f"‚ùå Error updating metrics: {e}")
        
        self.after(2000, self._update_metrics)
        
    def _update_datastream(self):
        """Update datastream visualization"""
        try:
            # Add random data point
            value = random.uniform(0, 100)
            self.data_stream.add_data_point(value)
            
        except Exception as e:
            print(f"‚ùå Error updating datastream: {e}")
        
        self.after(100, self._update_datastream)
        
    def _update_system_status(self):
        """Update system status display"""
        try:
            # Determine status based on metrics
            if self.metrics['cpu_usage'] > 80:
                status = "üî¥ CRITICAL"
                color = self.theme.colors['danger']
            elif self.metrics['cpu_usage'] > 60:
                status = "üü° WARNING"
                color = self.theme.colors['warning']
            else:
                status = "üü¢ OPERATIONAL"
                color = self.theme.colors['success']
            
            self.system_status_label.configure(
                text=f"SYSTEM STATUS: {status}",
                text_color=color
            )
            
            # Random connection status for demo
            connections = ["ESTABLISHED", "ACTIVE", "CONNECTED", "STABLE"]
            self.connection_label.configure(
                text=f"üåê CONNECTION: {random.choice(connections)}"
            )
            
        except Exception as e:
            print(f"‚ùå Error updating system status: {e}")
        
        self.after(3000, self._update_system_status)
        
    # Event Handlers
    
    def _on_send_message(self, event=None):
        """Handle send message"""
        message = self.message_input.get().strip()
        if not message:
            return
        
        # Clear input
        self.message_input.delete(0, "end")
        
        # Add to chat
        self._add_chat_message("YOU", message)
        
        # Process in background
        threading.Thread(
            target=self._process_message,
            args=(message,),
            daemon=True
        ).start()
        
    def _process_message(self, message: str):
        """Process chat message"""
        # MODIFICA√á√ÉO: Interagir com o novo ChatPanel
        try:
            # Simulate AI processing
            time.sleep(random.uniform(0.5, 1.5))
            
            # Get AI response
            response = self.language_model.get_response(message)
            
            # Add response to chat
            self.after(0, self.chat_panel.add_message, "R2", response.content)
            
            # Record in history
            self.history.add_chat_message("user", message)
            self.history.add_chat_message("assistant", response.content)
            
        except Exception as e:
            error_msg = f"Error processing message: {str(e)}"
            self.after(0, self.chat_panel.add_message, "SYSTEM", error_msg)
            
    def _process_simple_command(self):
        """Processa comandos na interface simplificada"""
        if hasattr(self, 'input_field'):
            command = self.input_field.get().strip()
            if not command:
                return
            
            self.console.insert("end", f"\n> {command}\n")
            
            # Processar comando b√°sico
            if command.lower() == 'ajuda':
                response = """Comandos dispon√≠veis:
‚Ä¢ status - Status do sistema
‚Ä¢ hora - Hora atual
‚Ä¢ data - Data atual
‚Ä¢ modulos - Lista m√≥dulos
‚Ä¢ reiniciar - Reiniciar interface
‚Ä¢ sair - Encerrar"""
            elif command.lower() == 'status':
                response = f"‚úÖ Sistema operacional\nCPU: {self.metrics['cpu_usage']:.1f}%\nMem√≥ria: {self.metrics['memory_usage']:.1f}%"
            elif command.lower() == 'hora':
                from datetime import datetime
                response = f"üïê {datetime.now().strftime('%H:%M:%S')}"
            elif command.lower() == 'data':
                from datetime import datetime
                response = f"üìÖ {datetime.now().strftime('%d/%m/%Y')}"
            elif command.lower() == 'modulos':
                modules = []
                if self.voice_engine:
                    modules.append("üé§ Voz")
                if self.alert_system:
                    modules.append("üö® Alertas")
                if self.command_system:
                    modules.append("ü§ñ Comandos")
                response = f"M√≥dulos ativos: {', '.join(modules) if modules else 'Nenhum'}"
            elif command.lower() == 'reiniciar':
                self._restart_gui()
                response = "Reiniciando..."
            elif command.lower() == 'sair':
                self.quit()
                return
            else:
                response = f"‚ùå Comando n√£o reconhecido: {command}"
            
            self.console.insert("end", f"{response}\n")
            self.input_field.delete(0, "end")
            self.console.see("end")
            
    def _toggle_voice(self):
        """Toggle voice recognition"""
        if not self.voice_active:
            # Activate voice
            self.voice_active = True
            self.voice_control_button.configure(
                text="üî¥ VOICE ACTIVE",
                fg_color=self.theme.colors['danger']
            )
            
            self._add_comm_log("üé§ Voice recognition: ACTIVATED")
            self._add_chat_message("SYSTEM", "Voice recognition activated")
            
            # Start voice engine
            self.voice_engine.start_listening(self._on_voice_command)
            
        else:
            # Deactivate voice
            self.voice_active = False
            self.voice_control_button.configure(
                text="üé§ VOICE",
                fg_color=self.theme.colors['primary']
            )
            
            self._add_comm_log("üé§ Voice recognition: DEACTIVATED")
            self._add_chat_message("SYSTEM", "Voice recognition deactivated")
            
            # Stop voice engine
            self.voice_engine.stop_listening()
            
    def _on_voice_command(self, command: str):
        """Handle voice command"""
        self.after(0, self._add_chat_message, "YOU (VOICE)", command)
        
        # Process command in background
        threading.Thread(
            target=self._process_voice_command,
            args=(command,),
            daemon=True
        ).start()
        
    def _process_voice_command(self, command: str):
        """Process voice command"""
        try:
            # Use command system
            success, result = self.command_system.execute_command(command)
            
            if success:
                response = f"Command executed: {result}"
            else:
                response = f"Error: {result}"
                
            self.after(0, self._add_chat_message, "R2", response)
            
        except Exception as e:
            error_msg = f"Error processing voice command: {str(e)}"
            self.after(0, self._add_chat_message, "SYSTEM", error_msg)

    def _on_alert_received_thread_safe(self, alert_data: Dict[str, Any]):
        """Callback seguro para alertas (executado na thread da UI)"""
        try:
            if hasattr(self, 'alert_panel') and self.alert_panel:
                self.alert_panel.add_alert(alert_data)
                self._add_comm_log(f"üö® ALERT: {alert_data.get('title', 'Alerta')}")
        except Exception as e:
            print(f"‚ö†Ô∏è Erro ao processar alerta na UI: {e}")
        
    def _add_comm_log(self, message: str):
        """Add message to communication log"""
        # MODIFICA√á√ÉO: Verificar se o widget existe
        if hasattr(self, 'comm_log') and self.comm_log:
            timestamp = datetime.now().strftime("%H:%M:%S")
            formatted = f"[{timestamp}] {message}\n"
            
            self.comm_log.insert("end", formatted)
            self.comm_log.see("end")
        
    def _add_chat_message(self, sender: str, message: str):
        """Add message to chat display"""
        # MODIFICA√á√ÉO: Interagir com o novo ChatPanel
        if hasattr(self, 'chat_panel'):
            self.chat_panel.add_message(sender, message)
        elif hasattr(self, 'console'): # Fallback para interface simples
            self.console.insert("end", f"[{sender}] {message}\n")
            self.console.see("end")

    def _restart_gui(self):
        """Reinicia a GUI"""
        print("üîÑ Reiniciando interface...")
        self.destroy()
        
        # Reimportar e recriar
        import importlib
        import sys
        import gui.sci_fi_hud
        
        importlib.reload(gui.sci_fi_hud)
        from gui.sci_fi_hud import R2SciFiGUI
        
        new_gui = R2SciFiGUI(self.config)
        new_gui.mainloop()
        
    # Window Openers
    
    def _open_modules(self):
        """Open modules window"""
        from .windows.modules_window import ModulesWindow
        ModulesWindow(self, self.module_manager)
        
    def _open_analytics(self):
        """Open analytics window"""
        from .windows.analytics_window import AnalyticsWindow
        AnalyticsWindow(self, self.analytics, self.history)
        
    def _open_trading(self):
        """Open trading window"""
        from .windows.trading_window import TradingWindow
        trading_module = self.module_manager.get_module("trading")
        TradingWindow(self, trading_module.instance if trading_module else None)
        
    def _open_settings(self):
        """Open settings window"""
        from .windows.settings_window import SettingsWindow
        SettingsWindow(self, self.config)

    def _show_status(self):
        """Mostra status do sistema"""
        if hasattr(self, 'console'):
            self.console.insert("end", "\nüìä STATUS DO SISTEMA:\n")
            self.console.insert("end", f"‚Ä¢ Voice Engine: {'‚úÖ' if self.voice_engine else '‚ùå'}\n")
            self.console.insert("end", f"‚Ä¢ Alert System: {'‚úÖ' if self.alert_system else '‚ùå'}\n")
            self.console.insert("end", f"‚Ä¢ Command System: {'‚úÖ' if self.command_system else '‚ùå'}\n")
            self.console.insert("end", f"‚Ä¢ CPU: {self.metrics['cpu_usage']:.1f}%\n")
            self.console.insert("end", f"‚Ä¢ Mem√≥ria: {self.metrics['memory_usage']:.1f}%\n")
            self.console.see("end")
        
    def run(self):
        """Run the application"""
        self.mainloop()
        
    def cleanup(self):
        """Cleanup resources"""
        print("üßπ Cleaning up GUI resources...")
        
        # Stop voice engine
        if self.voice_engine and self.voice_active:
            self.voice_engine.stop_listening()
            
        # Stop alert system
        if self.alert_system:
            self.alert_system.stop_monitoring()
        
        # Cleanup audio
        self.audio_processor.cleanup()